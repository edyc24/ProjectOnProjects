================================================================================
CERINȚA 2: CRIPTAREA DATELOR
================================================================================

CERINȚĂ:
Implementarea criptării datelor sensibile în baza de date Oracle pentru aplicația
MoneyShop. Datele sensibile (CNP, email, telefon) trebuie să fie criptate pentru
a proteja confidențialitatea utilizatorilor.

================================================================================
COD SQL
================================================================================

-- Funcție pentru criptare
CREATE OR REPLACE FUNCTION fn_encrypt_column (
    p_data IN VARCHAR2,
    p_key IN VARCHAR2 DEFAULT 'MONEYSHOP_ENCRYPT_KEY_2025'
) RETURN RAW
IS
    v_encrypted RAW(2000);
    v_key RAW(32);
    v_src RAW(2000);
BEGIN
    IF p_data IS NULL THEN
        RETURN NULL;
    END IF;
    
    v_src := UTL_RAW.CAST_TO_RAW(p_data);
    v_key := UTL_RAW.CAST_TO_RAW(SUBSTR(p_key || RPAD(' ', 32, ' '), 1, 32));
    
    BEGIN
        v_encrypted := DBMS_CRYPTO.ENCRYPT(
            src => v_src,
            typ => DBMS_CRYPTO.ENCRYPT_AES256 + DBMS_CRYPTO.CHAIN_CBC + DBMS_CRYPTO.PAD_PKCS5,
            key => v_key
        );
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END;
    
    RETURN v_encrypted;
EXCEPTION
    WHEN OTHERS THEN
        RETURN NULL;
END;
/

-- Funcție pentru decriptare
CREATE OR REPLACE FUNCTION fn_decrypt_column (
    p_encrypted IN RAW,
    p_key IN VARCHAR2 DEFAULT 'MONEYSHOP_ENCRYPT_KEY_2025'
) RETURN VARCHAR2
IS
    v_decrypted RAW(2000);
    v_key RAW(32);
BEGIN
    IF p_encrypted IS NULL THEN
        RETURN NULL;
    END IF;
    
    v_key := UTL_RAW.CAST_TO_RAW(SUBSTR(p_key || RPAD(' ', 32, ' '), 1, 32));
    
    BEGIN
        v_decrypted := DBMS_CRYPTO.DECRYPT(
            src => p_encrypted,
            typ => DBMS_CRYPTO.ENCRYPT_AES256 + DBMS_CRYPTO.CHAIN_CBC + DBMS_CRYPTO.PAD_PKCS5,
            key => v_key
        );
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END;
    
    RETURN UTL_RAW.CAST_TO_VARCHAR2(v_decrypted);
EXCEPTION
    WHEN OTHERS THEN
        RETURN NULL;
END;
/

-- Adăugare coloane criptate
DECLARE
    v_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM user_tab_columns
    WHERE table_name = 'UTILIZATORI' AND column_name = 'CNP_ENCRYPTED';
    
    IF v_count = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE UTILIZATORI ADD CNP_Encrypted RAW(2000)';
    END IF;
    
    SELECT COUNT(*) INTO v_count
    FROM user_tab_columns
    WHERE table_name = 'UTILIZATORI' AND column_name = 'EMAIL_ENCRYPTED';
    
    IF v_count = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE UTILIZATORI ADD Email_Encrypted RAW(2000)';
    END IF;
    
    SELECT COUNT(*) INTO v_count
    FROM user_tab_columns
    WHERE table_name = 'UTILIZATORI' AND column_name = 'TELEFON_ENCRYPTED';
    
    IF v_count = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE UTILIZATORI ADD Telefon_Encrypted RAW(2000)';
    END IF;
END;
/

-- View pentru decriptare
CREATE OR REPLACE VIEW vw_utilizatori_decrypted AS
SELECT 
    IdUtilizator,
    Nume,
    Prenume,
    Username,
    Email,
    Email_Encrypted,
    Email AS Email_Decrypted,
    NumarTelefon,
    Telefon_Encrypted,
    NumarTelefon AS Telefon_Decrypted,
    EmailVerified,
    PhoneVerified,
    DataNastere,
    IdRol,
    IsDeleted,
    CreatedAt,
    UpdatedAt
FROM UTILIZATORI
WHERE IsDeleted = 0;

-- Proceduri criptare
CREATE OR REPLACE PROCEDURE sp_encrypt_user_email (p_user_id IN NUMBER)
IS
BEGIN
    UPDATE UTILIZATORI
    SET Email_Encrypted = fn_encrypt_column(Email)
    WHERE IdUtilizator = p_user_id;
    
    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE sp_encrypt_user_telefon (p_user_id IN NUMBER)
IS
BEGIN
    UPDATE UTILIZATORI
    SET Telefon_Encrypted = fn_encrypt_column(NumarTelefon)
    WHERE IdUtilizator = p_user_id
      AND NumarTelefon IS NOT NULL;
    
    COMMIT;
END;
/
