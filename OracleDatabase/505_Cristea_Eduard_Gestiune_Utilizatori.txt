================================================================================
CERINȚA 4: GESTIUNEA UTILIZATORILOR ȘI A RESURSELOR COMPUTAȚIONALE
================================================================================

CERINȚĂ:
Proiectarea și implementarea configurației de management a identităților în
baza de date, incluzând:
a) Matrici proces-utilizator
b) Matrici entitate-proces
c) Matrici entitate-utilizator

================================================================================
COD SQL
================================================================================

-- Tabel PROCESE
CREATE TABLE PROCESE (
    IdProces NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    NumeProces VARCHAR2(100) NOT NULL UNIQUE,
    Descriere VARCHAR2(500),
    TipProces VARCHAR2(50) NOT NULL,
    CreatedAt TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT chk_tip_proces CHECK (TipProces IN ('READ', 'WRITE', 'DELETE', 'ADMIN', 'EXECUTE'))
);

-- Tabel PROCES_UTILIZATOR
CREATE TABLE PROCES_UTILIZATOR (
    Id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    IdProces NUMBER NOT NULL,
    IdUtilizator NUMBER NOT NULL,
    Status VARCHAR2(50) DEFAULT 'ACTIV',
    DataAsignare TIMESTAMP DEFAULT SYSTIMESTAMP,
    DataExpirare TIMESTAMP,
    CreatedAt TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT fk_proc_util_proces FOREIGN KEY (IdProces) REFERENCES PROCESE(IdProces),
    CONSTRAINT fk_proc_util_user FOREIGN KEY (IdUtilizator) REFERENCES UTILIZATORI(IdUtilizator),
    CONSTRAINT chk_proc_util_status CHECK (Status IN ('ACTIV', 'INACTIV', 'EXPIRAT')),
    CONSTRAINT uk_proc_util UNIQUE (IdProces, IdUtilizator)
);

-- Tabel ENTITATE_PROCES
CREATE TABLE ENTITATE_PROCES (
    Id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    NumeEntitate VARCHAR2(100) NOT NULL,
    IdProces NUMBER NOT NULL,
    Permisiune VARCHAR2(50) NOT NULL,
    CreatedAt TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT fk_ent_proc_proces FOREIGN KEY (IdProces) REFERENCES PROCESE(IdProces),
    CONSTRAINT chk_permisiune CHECK (Permisiune IN ('ALLOW', 'DENY')),
    CONSTRAINT uk_ent_proc UNIQUE (NumeEntitate, IdProces)
);

-- Tabel ENTITATE_UTILIZATOR
CREATE TABLE ENTITATE_UTILIZATOR (
    Id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    NumeEntitate VARCHAR2(100) NOT NULL,
    IdUtilizator NUMBER NOT NULL,
    TipAcces VARCHAR2(50) NOT NULL,
    ConditieWhere VARCHAR2(1000),
    Status VARCHAR2(50) DEFAULT 'ACTIV',
    CreatedAt TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT fk_ent_util_user FOREIGN KEY (IdUtilizator) REFERENCES UTILIZATORI(IdUtilizator),
    CONSTRAINT chk_tip_acces CHECK (TipAcces IN ('READ', 'WRITE', 'DELETE', 'ALL')),
    CONSTRAINT chk_ent_util_status CHECK (Status IN ('ACTIV', 'INACTIV', 'EXPIRAT'))
);

-- Inserare procese
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('VIEW_OWN_APPLICATIONS', 'Vizualizare propriile aplicații', 'READ');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('CREATE_APPLICATION', 'Creare aplicație nouă', 'WRITE');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('UPDATE_OWN_APPLICATION', 'Actualizare propria aplicație', 'WRITE');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('DELETE_OWN_APPLICATION', 'Ștergere propria aplicație', 'DELETE');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('VIEW_ALL_APPLICATIONS', 'Vizualizare toate aplicațiile (broker)', 'READ');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('PROCESS_APPLICATION', 'Procesare aplicație (broker)', 'WRITE');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('VIEW_USERS', 'Vizualizare utilizatori (admin)', 'READ');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('MANAGE_USERS', 'Gestionare utilizatori (admin)', 'ADMIN');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('VIEW_REPORTS', 'Vizualizare rapoarte', 'READ');
INSERT INTO PROCESE (NumeProces, Descriere, TipProces) VALUES ('EXECUTE_ADMIN_PROC', 'Executare proceduri admin', 'EXECUTE');
COMMIT;

-- Funcție verificare acces
CREATE OR REPLACE FUNCTION fn_utilizator_poate_proces (
    p_user_id IN NUMBER,
    p_nume_proces IN VARCHAR2
) RETURN NUMBER
IS
    v_count NUMBER;
    v_rol VARCHAR2(50);
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM PROCES_UTILIZATOR pu
    JOIN PROCESE p ON pu.IdProces = p.IdProces
    WHERE pu.IdUtilizator = p_user_id
      AND p.NumeProces = p_nume_proces
      AND pu.Status = 'ACTIV'
      AND (pu.DataExpirare IS NULL OR pu.DataExpirare > SYSTIMESTAMP);
    
    IF v_count > 0 THEN
        RETURN 1;
    END IF;
    
    SELECT r.NumeRol INTO v_rol
    FROM UTILIZATORI u
    JOIN ROLURI r ON u.IdRol = r.IdRol
    WHERE u.IdUtilizator = p_user_id;
    
    IF v_rol = 'ADMIN' THEN
        RETURN 1;
    ELSIF v_rol = 'BROKER' AND p_nume_proces IN ('VIEW_ALL_APPLICATIONS', 'PROCESS_APPLICATION') THEN
        RETURN 1;
    ELSIF v_rol = 'CLIENT' AND p_nume_proces IN ('VIEW_OWN_APPLICATIONS', 'CREATE_APPLICATION', 'UPDATE_OWN_APPLICATION', 'DELETE_OWN_APPLICATION') THEN
        RETURN 1;
    END IF;
    
    RETURN 0;
END;
/
