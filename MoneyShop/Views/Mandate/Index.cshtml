@{
    ViewData["Title"] = "Mandate și Consimțăminte - MoneyShop";
    Layout = "_Layout";
}

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Mandate și Consimțăminte</h1>
            <p class="text-gray-600 mt-2">Gestionează mandatele tale pentru interogarea ANAF și Biroul de Credit</p>
        </div>

        <!-- Alert for expiring mandates -->
        <div id="expiringAlert" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-center gap-3">
                <span class="material-icons-outlined text-yellow-600">warning</span>
                <div>
                    <p class="font-medium text-yellow-800">Mandate care expiră curând</p>
                    <p class="text-sm text-yellow-700" id="expiringText">Ai mandate care expiră în mai puțin de 7 zile.</p>
                </div>
            </div>
        </div>

        <!-- Active Mandates -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    <span class="material-icons-outlined text-green-600">verified</span>
                    Mandate Active
                </h2>
            </div>
            <div id="activeMandates" class="p-6">
                <div class="text-center text-gray-500 py-8">
                    <span class="material-icons-outlined text-4xl mb-2">hourglass_empty</span>
                    <p>Se încarcă...</p>
                </div>
            </div>
        </div>

        <!-- Expired/Revoked Mandates -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    <span class="material-icons-outlined text-gray-400">history</span>
                    Istoric Mandate
                </h2>
            </div>
            <div id="historyMandates" class="p-6">
                <div class="text-center text-gray-500 py-4">
                    <p>Nu există mandate expirate sau revocate.</p>
                </div>
            </div>
        </div>

        <!-- Create New Mandate -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="material-icons-outlined text-blue-600">add_circle</span>
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold text-blue-900">Creează un nou mandat</h3>
                    <p class="text-sm text-blue-700 mt-1 mb-4">
                        Pentru a verifica eligibilitatea ta pentru credite, avem nevoie de un mandat 
                        care ne permite să interogăm ANAF și/sau Biroul de Credit.
                    </p>
                    <div class="flex gap-3">
                        <button onclick="showCreateMandateModal('ANAF')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Mandat ANAF
                        </button>
                        <button onclick="showCreateMandateModal('BC')" 
                            class="bg-white border border-blue-300 hover:bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Mandat Birou Credit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info -->
        <div class="mt-8 text-center text-sm text-gray-500">
            <p class="flex items-center justify-center gap-2 mb-2">
                <span class="material-icons-outlined text-lg">info</span>
                Mandatele sunt valabile 30 de zile și pot fi revocate oricând.
            </p>
        </div>
    </div>
</div>

<!-- Create Mandate Modal -->
<div id="createMandateModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">Creare Mandat</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-icons-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <div id="modalContent">
                <p class="text-gray-600 mb-4" id="modalDescription">
                    Sunteți pe cale să acordați un mandat pentru interogarea ANAF.
                </p>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4 text-sm">
                    <p class="font-medium text-gray-900 mb-2">Ce implică acest mandat:</p>
                    <ul class="space-y-1 text-gray-600" id="modalList">
                        <li class="flex items-start gap-2">
                            <span class="material-icons-outlined text-green-500 text-sm mt-0.5">check</span>
                            Verificarea veniturilor declarate
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="material-icons-outlined text-green-500 text-sm mt-0.5">check</span>
                            Valabilitate: 30 de zile
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="material-icons-outlined text-green-500 text-sm mt-0.5">check</span>
                            Poate fi revocat oricând
                        </li>
                    </ul>
                </div>

                <div class="flex items-start gap-3 mb-6">
                    <input type="checkbox" id="confirmMandate" class="mt-1 w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="confirmMandate" class="text-sm text-gray-700">
                        Confirm că am citit și sunt de acord cu 
                        <a href="/Legal/Mandate" target="_blank" class="text-blue-600 hover:underline">termenii mandatului</a>.
                    </label>
                </div>
            </div>

            <div id="modalLoading" class="hidden text-center py-8">
                <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">Se procesează cererea...</p>
            </div>

            <div id="modalSuccess" class="hidden text-center py-8">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-icons-outlined text-green-600 text-3xl">check_circle</span>
                </div>
                <p class="text-gray-900 font-medium">Mandat creat cu succes!</p>
                <p class="text-sm text-gray-600 mt-2">PDF-ul mandatului a fost generat.</p>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3" id="modalButtons">
            <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                Anulează
            </button>
            <button onclick="createMandate()" id="confirmBtn" disabled
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Confirmă mandatul
            </button>
        </div>
    </div>
</div>

@section Styles {
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
}

@section Scripts {
    <script>
        // Get user ID from session/token
        const userId = @(ViewBag.UserId ?? 1); // TODO: Get from session
        let currentMandateType = 'ANAF';

        // Load mandates on page load
        document.addEventListener('DOMContentLoaded', loadMandates);

        async function loadMandates() {
            try {
                const response = await fetch(`/api/mandate/list/${userId}`);
                const data = await response.json();
                
                if (data.mandates) {
                    renderMandates(data.mandates);
                }
            } catch (error) {
                console.error('Error loading mandates:', error);
                document.getElementById('activeMandates').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <span class="material-icons-outlined text-4xl mb-2">error</span>
                        <p>Eroare la încărcarea mandatelor.</p>
                    </div>
                `;
            }
        }

        function renderMandates(mandates) {
            const active = mandates.filter(m => m.status === 'active' && !m.isExpired);
            const history = mandates.filter(m => m.status !== 'active' || m.isExpired);

            // Check for expiring mandates
            const expiring = active.filter(m => m.daysRemaining <= 7);
            if (expiring.length > 0) {
                document.getElementById('expiringAlert').classList.remove('hidden');
                document.getElementById('expiringText').textContent = 
                    `Ai ${expiring.length} mandat(e) care expiră în mai puțin de 7 zile.`;
            }

            // Render active mandates
            if (active.length === 0) {
                document.getElementById('activeMandates').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <span class="material-icons-outlined text-4xl mb-2 text-gray-300">assignment_late</span>
                        <p>Nu ai mandate active.</p>
                        <p class="text-sm mt-1">Creează un mandat pentru a verifica eligibilitatea ta.</p>
                    </div>
                `;
            } else {
                document.getElementById('activeMandates').innerHTML = active.map(m => renderMandateCard(m, true)).join('');
            }

            // Render history
            if (history.length === 0) {
                document.getElementById('historyMandates').innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>Nu există mandate expirate sau revocate.</p>
                    </div>
                `;
            } else {
                document.getElementById('historyMandates').innerHTML = history.map(m => renderMandateCard(m, false)).join('');
            }
        }

        function renderMandateCard(mandate, isActive) {
            const typeLabel = {
                'ANAF': 'ANAF',
                'BC': 'Birou Credit',
                'ANAF_BC': 'ANAF + Birou Credit'
            }[mandate.mandateType] || mandate.mandateType;

            const statusColor = {
                'active': 'bg-green-100 text-green-700',
                'revoked': 'bg-red-100 text-red-700',
                'expired': 'bg-gray-100 text-gray-700'
            }[mandate.status] || 'bg-gray-100 text-gray-700';

            const statusLabel = {
                'active': 'Activ',
                'revoked': 'Revocat',
                'expired': 'Expirat'
            }[mandate.status] || mandate.status;

            const grantedDate = new Date(mandate.grantedAt).toLocaleDateString('ro-RO', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
            const expiresDate = new Date(mandate.expiresAt).toLocaleDateString('ro-RO', {
                day: '2-digit', month: 'short', year: 'numeric'
            });

            return `
                <div class="border border-gray-200 rounded-lg p-4 mb-4 last:mb-0 ${isActive ? 'bg-white' : 'bg-gray-50'}">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 ${isActive ? 'bg-blue-100' : 'bg-gray-200'} rounded-full flex items-center justify-center">
                                <span class="material-icons-outlined ${isActive ? 'text-blue-600' : 'text-gray-400'}">
                                    ${mandate.mandateType === 'ANAF' ? 'account_balance' : 'credit_score'}
                                </span>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-medium text-gray-900">Mandat ${typeLabel}</h4>
                                    <span class="px-2 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                        ${mandate.isExpired ? 'Expirat' : statusLabel}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500">
                                    Acordat: ${grantedDate} • Expiră: ${expiresDate}
                                </p>
                                ${isActive && mandate.daysRemaining <= 7 ? `
                                    <p class="text-sm text-yellow-600 mt-1 flex items-center gap-1">
                                        <span class="material-icons-outlined text-sm">schedule</span>
                                        Expiră în ${mandate.daysRemaining} zile
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="downloadPdf('${mandate.mandateId}')" 
                                class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                title="Descarcă PDF">
                                <span class="material-icons-outlined">download</span>
                            </button>
                            ${isActive ? `
                                <button onclick="confirmRevoke('${mandate.mandateId}')" 
                                    class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                    title="Revocă mandatul">
                                    <span class="material-icons-outlined">cancel</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function showCreateMandateModal(type) {
            currentMandateType = type;
            const modal = document.getElementById('createMandateModal');
            const title = document.getElementById('modalTitle');
            const description = document.getElementById('modalDescription');
            
            title.textContent = `Creare Mandat ${type === 'ANAF' ? 'ANAF' : 'Birou Credit'}`;
            description.textContent = type === 'ANAF' 
                ? 'Sunteți pe cale să acordați un mandat pentru interogarea ANAF.'
                : 'Sunteți pe cale să acordați un mandat pentru interogarea Biroului de Credit.';
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Reset modal state
            document.getElementById('modalContent').classList.remove('hidden');
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalSuccess').classList.add('hidden');
            document.getElementById('modalButtons').classList.remove('hidden');
            document.getElementById('confirmMandate').checked = false;
            document.getElementById('confirmBtn').disabled = true;
        }

        function closeModal() {
            const modal = document.getElementById('createMandateModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            loadMandates(); // Refresh list
        }

        // Enable confirm button when checkbox is checked
        document.getElementById('confirmMandate').addEventListener('change', function() {
            document.getElementById('confirmBtn').disabled = !this.checked;
        });

        async function createMandate() {
            document.getElementById('modalContent').classList.add('hidden');
            document.getElementById('modalButtons').classList.add('hidden');
            document.getElementById('modalLoading').classList.remove('hidden');

            try {
                // First create the mandate
                const createResponse = await fetch('/api/mandate/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        mandateType: currentMandateType,
                        expiresInDays: 30,
                        sourceChannel: 'web'
                    })
                });

                const createData = await createResponse.json();

                if (createResponse.ok) {
                    // Generate PDF
                    await fetch(`/api/mandate/${createData.mandateId}/generate-pdf`, {
                        method: 'POST'
                    });

                    document.getElementById('modalLoading').classList.add('hidden');
                    document.getElementById('modalSuccess').classList.remove('hidden');

                    setTimeout(() => {
                        closeModal();
                    }, 2000);
                } else {
                    throw new Error(createData.message || 'Error creating mandate');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Eroare la crearea mandatului: ' + error.message);
                closeModal();
            }
        }

        function downloadPdf(mandateId) {
            window.open(`/api/mandate/${mandateId}/download`, '_blank');
        }

        async function confirmRevoke(mandateId) {
            if (!confirm('Ești sigur că vrei să revoci acest mandat? Această acțiune este ireversibilă.')) {
                return;
            }

            try {
                const response = await fetch(`/api/mandate/${mandateId}/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'User requested revocation' })
                });

                if (response.ok) {
                    alert('Mandatul a fost revocat cu succes.');
                    loadMandates();
                } else {
                    const data = await response.json();
                    alert('Eroare: ' + (data.message || 'Nu s-a putut revoca mandatul.'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Eroare la revocare.');
            }
        }
    </script>
}

