@model List<MoneyShop.Controllers.SimpleItemViewModel>
@{
    ViewData["Title"] = "Simple Items - MoneyShop";
    Layout = "_Layout";
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">Simple Items List</h2>
                    <p class="mb-0 small">Homework 2 - Persistent Items in Azure SQL Database</p>
                </div>
                <div class="card-body">
                    <!-- Input Form -->
                    <div class="mb-4">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="itemInput" 
                                   placeholder="Enter item text..." 
                                   maxlength="500">
                            <button class="btn btn-primary btn-lg" 
                                    type="button" 
                                    id="enterButton"
                                    onclick="addItem()">
                                Enter
                            </button>
                        </div>
                        <div id="errorMessage" class="text-danger mt-2" style="display: none;"></div>
                        <div id="successMessage" class="text-success mt-2" style="display: none;"></div>
                    </div>

                    <!-- Items List -->
                    <div id="itemsList">
                        <h4 class="mb-3">Items List</h4>
                        @if (Model != null && Model.Any())
                        {
                            <ul class="list-group" id="itemsContainer">
                                @foreach (var item in Model)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@item.Text</strong>
                                            <br>
                                            <small class="text-muted">Added: @item.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</small>
                                        </div>
                                        <span class="badge bg-secondary">#@item.Id</span>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <p class="mb-0">No items yet. Add your first item above!</p>
                            </div>
                            <ul class="list-group" id="itemsContainer" style="display: none;"></ul>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function addItem() {
            const input = document.getElementById('itemInput');
            const button = document.getElementById('enterButton');
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const text = input.value.trim();

            // Clear previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (!text) {
                errorDiv.textContent = 'Please enter some text';
                errorDiv.style.display = 'block';
                return;
            }

            // Disable button during request
            button.disabled = true;
            button.textContent = 'Adding...';

            // Trimite request AJAX la backend
            fetch('/api/simple/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to add item');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Clear input
                input.value = '';

                // Show success message
                successDiv.textContent = 'Item added successfully!';
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);

                // Add item to list
                const container = document.getElementById('itemsContainer');
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    // Remove "no items" message if exists
                    const alertDiv = container.previousElementSibling;
                    if (alertDiv && alertDiv.classList.contains('alert')) {
                        alertDiv.remove();
                    }
                }

                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <strong>${data.text}</strong>
                        <br>
                        <small class="text-muted">Added: ${new Date(data.createdAt).toLocaleString()}</small>
                    </div>
                    <span class="badge bg-secondary">#${data.id}</span>
                `;
                container.insertBefore(li, container.firstChild);

                // Re-enable button
                button.disabled = false;
                button.textContent = 'Enter';
            })
            .catch(error => {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                button.disabled = false;
                button.textContent = 'Enter';
            });
        }

        // Allow Enter key to submit
        document.getElementById('itemInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addItem();
            }
        });
    </script>
}

