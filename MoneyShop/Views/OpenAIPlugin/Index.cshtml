@{
    ViewData["Title"] = "Azure OpenAI Plugin - Test Page";
    Layout = "_Layout";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        ü§ñ Azure OpenAI Plugin - Text Summarizer
                    </h2>
                    <small>Homework 4 - Test Interface</small>
                </div>
                <div class="card-body">
                    <!-- Plugin Info Section -->
                    <div class="mb-4">
                        <h4>Plugin Information</h4>
                        <button id="btnGetInfo" class="btn btn-info mb-3">
                            ‚ÑπÔ∏è Get Plugin Info
                        </button>
                        <div id="infoResult" class="alert alert-secondary" style="display: none;">
                            <pre id="infoContent" class="mb-0"></pre>
                        </div>
                    </div>

                    <hr />

                    <!-- Prompt Section -->
                    <div>
                        <h4>Test Prompt</h4>
                        <form id="promptForm">
                            <div class="mb-3">
                                <label for="promptInput" class="form-label">
                                    Enter text to summarize:
                                </label>
                                <textarea 
                                    id="promptInput" 
                                    class="form-control" 
                                    rows="6" 
                                    placeholder="Enter your text here... For example: Azure OpenAI este un serviciu cloud care oferƒÉ acces la modele de inteligen»õƒÉ artificialƒÉ dezvoltate de OpenAI. Acesta permite dezvoltatorilor sƒÉ integreze capabilitƒÉ»õi de AI √Æn aplica»õiile lor folosind infrastructura Azure."
                                    required></textarea>
                                <div class="form-text">
                                    This plugin will summarize the text using Azure OpenAI.
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="btnSubmit">
                                üì§ Process Prompt
                            </button>
                            <button type="button" class="btn btn-secondary" id="btnClear">
                                üóëÔ∏è Clear
                            </button>
                        </form>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection" class="mt-4" style="display: none;">
                        <h5>Result:</h5>
                        <div id="resultCard" class="card">
                            <div class="card-body">
                                <div id="resultContent" class="mb-2"></div>
                                <hr />
                                <small class="text-muted">
                                    <strong>Model:</strong> <span id="resultModel"></span> | 
                                    <strong>Status:</strong> <span id="resultStatus"></span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Error Section -->
                    <div id="errorSection" class="mt-4" style="display: none;">
                        <div id="errorCard" class="alert alert-danger">
                            <h6 class="alert-heading">Error</h6>
                            <div id="errorContent"></div>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing your request...</p>
                    </div>
                </div>
            </div>

            <!-- API Endpoints Info -->
            <div class="card mt-4 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">API Endpoints</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>GET /api/openai-plugin/info</h6>
                            <code class="small">Returns plugin information</code>
                        </div>
                        <div class="col-md-6">
                            <h6>POST /api/openai-plugin/prompt</h6>
                            <code class="small">Processes a prompt and returns AI response</code>
                        </div>
                    </div>
                    <hr />
                    <p class="mb-0">
                        <small class="text-muted">
                            <strong>Note:</strong> Make sure Azure OpenAI is configured in appsettings.json 
                            (Endpoint, ApiKey, DeploymentName, ApiVersion)
                        </small>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '/api/openai-plugin';

        // Get Plugin Info
        document.getElementById('btnGetInfo').addEventListener('click', async function() {
            const infoResult = document.getElementById('infoResult');
            const infoContent = document.getElementById('infoContent');
            
            try {
                const response = await fetch(`${API_BASE_URL}/info`);
                const data = await response.json();
                
                infoContent.textContent = JSON.stringify(data, null, 2);
                infoResult.style.display = 'block';
                infoResult.className = 'alert alert-success';
            } catch (error) {
                infoContent.textContent = `Error: ${error.message}`;
                infoResult.style.display = 'block';
                infoResult.className = 'alert alert-danger';
            }
        });

        // Handle Prompt Form Submission
        document.getElementById('promptForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const promptInput = document.getElementById('promptInput');
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                alert('Please enter some text to summarize.');
                return;
            }

            // Hide previous results/errors
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            
            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('btnSubmit').disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                const data = await response.json();

                // Hide loading
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('btnSubmit').disabled = false;

                if (response.ok) {
                    // Show success result
                    document.getElementById('resultContent').textContent = data.result || data.message || 'No result returned';
                    document.getElementById('resultModel').textContent = data.model || 'N/A';
                    document.getElementById('resultStatus').textContent = data.success ? 'Success' : 'Failed';
                    document.getElementById('resultCard').className = 'card border-success';
                    document.getElementById('resultsSection').style.display = 'block';
                } else {
                    // Show error
                    const errorMsg = data.message || data.error || 'An error occurred';
                    document.getElementById('errorContent').innerHTML = `
                        <strong>Status ${response.status}:</strong> ${errorMsg}
                        ${data.details ? `<br><small>${data.details}</small>` : ''}
                    `;
                    document.getElementById('errorSection').style.display = 'block';
                }
            } catch (error) {
                // Hide loading
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('btnSubmit').disabled = false;

                // Show error
                document.getElementById('errorContent').innerHTML = `
                    <strong>Network Error:</strong> ${error.message}
                    <br><small>Please check your connection and try again.</small>
                `;
                document.getElementById('errorSection').style.display = 'block';
            }
        });

        // Clear button
        document.getElementById('btnClear').addEventListener('click', function() {
            document.getElementById('promptInput').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('infoResult').style.display = 'none';
        });
    </script>
}

